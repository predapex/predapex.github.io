import React, { useState } from "react";

// Util: Given a valve open/close, returns a color for water animation
const getWaterColor = (isOpen) => (isOpen ? "#33caff" : "#cccccc");

// Layout positions
const tankY = 80;
const tankSpacing = 140;
const pumpX = 350;
const pumpY = 220;
const valveRadius = 12;

const tankNames = ["T1", "T2", "T3", "T4"];

export default function WaterTankSystem() {
  // State: [false, false, false, false]
  const [suctionValves, setSuctionValves] = useState([false, false, false, false]);
  const [returnValves, setReturnValves] = useState([false, false, false, false]);
  const [pumpOn, setPumpOn] = useState(false);

  // Toggle helpers
  const togglePump = () => setPumpOn((p) => !p);
  const toggleSuction = (i) => setSuctionValves((v) => v.map((val, idx) => (idx === i ? !val : val)));
  const toggleReturn = (i) => setReturnValves((v) => v.map((val, idx) => (idx === i ? !val : val)));

  // For animation: Find which tanks are sending/receiving water
  const activeFlows = [];
  if (pumpOn) {
    suctionValves.forEach((sOpen, i) => {
      returnValves.forEach((rOpen, j) => {
        if (sOpen && rOpen) {
          activeFlows.push({ from: i, to: j });
        }
      });
    });
  }

  return (
    <div style={{ userSelect: "none" }}>
      <svg width={700} height={400}>
        {/* Tanks */}
        {tankNames.map((name, i) => (
          <g key={name}>
            {/* Tank */}
            <rect
              x={i * tankSpacing + 50}
              y={tankY}
              width={60}
              height={100}
              fill="#b3e0ff"
              stroke="#333"
              strokeWidth={2}
              rx={10}
            />
            {/* Tank Label */}
            <text
              x={i * tankSpacing + 80}
              y={tankY + 120}
              textAnchor="middle"
              fontWeight="bold"
              fontSize={16}
            >
              {name}
            </text>
          </g>
        ))}

        {/* Pump */}
        <g>
          <ellipse
            cx={pumpX}
            cy={pumpY}
            rx={36}
            ry={28}
            fill={pumpOn ? "#b3ffb3" : "#dddddd"}
            stroke="#333"
            strokeWidth={3}
          />
          <text
            x={pumpX}
            y={pumpY + 5}
            textAnchor="middle"
            fontWeight="bold"
            fontSize={18}
            fill="#333"
          >
            PUMP
          </text>
        </g>

        {/* Suction Manifold lines & valves */}
        {tankNames.map((_, i) => {
          const x = i * tankSpacing + 80;
          // Valve position
          const valveX = x;
          const valveY = tankY + 100 + 20;
          // Pipe from tank to valve
          return (
            <g key={`suction_${i}`}>
              {/* From tank bottom to valve */}
              <line
                x1={x}
                y1={tankY + 100}
                x2={x}
                y2={valveY}
                stroke="#444"
                strokeWidth={5}
              />
              {/* Valve */}
              <circle
                cx={valveX}
                cy={valveY + valveRadius + 5}
                r={valveRadius}
                fill={suctionValves[i] ? "#33caff" : "#fff"}
                stroke="#444"
                strokeWidth={2}
                style={{ cursor: "pointer" }}
                onClick={() => toggleSuction(i)}
              />
              <text x={valveX} y={valveY + valveRadius + 30} fontSize={10} textAnchor="middle">
                S
              </text>
              {/* From valve to pump */}
              <line
                x1={valveX}
                y1={valveY + 2 * valveRadius + 10}
                x2={pumpX - 10}
                y2={pumpY - 28}
                stroke={getWaterColor(suctionValves[i] && pumpOn)}
                strokeWidth={5}
                markerEnd={suctionValves[i] && pumpOn ? "url(#arrowhead)" : undefined}
                style={{
                  transition: "stroke 0.3s"
                }}
              />
            </g>
          );
        })}

        {/* Return Manifold lines & valves */}
        {tankNames.map((_, i) => {
          const x = i * tankSpacing + 80;
          // Valve position
          const valveX = x;
          const valveY = pumpY + 28 + 30;
          // From pump to valve
          return (
            <g key={`return_${i}`}>
              <line
                x1={pumpX + 10}
                y1={pumpY + 28}
                x2={valveX}
                y2={valveY}
                stroke={getWaterColor(returnValves[i] && pumpOn)}
                strokeWidth={5}
                markerEnd={returnValves[i] && pumpOn ? "url(#arrowhead)" : undefined}
                style={{
                  transition: "stroke 0.3s"
                }}
              />
              {/* Valve */}
              <circle
                cx={valveX}
                cy={valveY}
                r={valveRadius}
                fill={returnValves[i] ? "#33caff" : "#fff"}
                stroke="#444"
                strokeWidth={2}
                style={{ cursor: "pointer" }}
                onClick={() => toggleReturn(i)}
              />
              <text x={valveX} y={valveY + 22} fontSize={10} textAnchor="middle">
                R
              </text>
              {/* From valve to tank */}
              <line
                x1={valveX}
                y1={valveY + valveRadius}
                x2={valveX}
                y2={tankY + 100}
                stroke="#444"
                strokeWidth={5}
              />
            </g>
          );
        })}

        {/* Animate active flows */}
        {activeFlows.map(({ from, to }, idx) => {
          // Animate water from tank 'from' through pump to tank 'to'
          // Draw a blue line from left tank 'from' to pump, then to right tank 'to'
          const xFrom = from * tankSpacing + 80;
          const xTo = to * tankSpacing + 80;
          const path = `M ${xFrom} ${tankY + 100}
            L ${xFrom} ${tankY + 100 + 20 + 2 * valveRadius + 10}
            L ${pumpX - 10} ${pumpY - 28}
            L ${pumpX + 10} ${pumpY + 28}
            L ${xTo} ${pumpY + 28 + 30}
            L ${xTo} ${tankY + 100}`;
          return (
            <path
              key={idx}
              d={path}
              stroke="#33caff"
              strokeWidth={7}
              fill="none"
              opacity={0.7}
              style={{
                filter: "drop-shadow(0px 0px 6px #33caff)",
                strokeDasharray: 40,
                strokeDashoffset: (Date.now() / 50) % 40
              }}
            />
          );
        })}

        {/* Arrow marker for flow */}
        <defs>
          <marker
            id="arrowhead"
            markerWidth="10"
            markerHeight="7"
            refX="8"
            refY="3.5"
            orient="auto"
            markerUnits="strokeWidth"
          >
            <polygon points="0 0, 10 3.5, 0 7" fill="#33caff" />
          </marker>
        </defs>
      </svg>
      {/* Pump toggle button */}
      <div style={{ textAlign: "center", marginTop: 10 }}>
        <button
          onClick={togglePump}
          style={{
            fontSize: 20,
            padding: "10px 30px",
            background: pumpOn ? "#b3ffb3" : "#eee",
            border: "2px solid #333",
            borderRadius: 10,
            marginTop: 10
          }}
        >
          {pumpOn ? "Stop Pump" : "Start Pump"}
        </button>
      </div>
      {/* Valve legend */}
      <div style={{ textAlign: "center", marginTop: 5, fontSize: 14 }}>
        <span style={{ color: "#33caff", marginRight: 10 }}>●</span> Open Valve
        <span style={{ color: "#fff", border: "1px solid #444", marginLeft: 20, marginRight: 10 }}>●</span> Closed Valve
      </div>
      <div style={{ textAlign: "center", marginTop: 5, fontSize: 14 }}>
        Click on blue/white circles to open or close valves.
      </div>
    </div>
  );
}
